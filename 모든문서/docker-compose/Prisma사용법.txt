# Prisma 사용법 (이 프로젝트 기준)

## 1. 기본 Prisma 명령어

  npx prisma                    # CLI 도움말
  npx prisma init               # prisma/schema.prisma, .env 생성 (신규 프로젝트 시 한 번)
  npx prisma generate           # Prisma Client 재생성 (스키마 변경 후)
  npx prisma format              # schema.prisma 포맷
  npx prisma validate            # schema.prisma 문법 검사


## 2. 마이그레이션 (개발용)

  # 스키마 변경 후 마이그레이션 생성 + DB 적용 (개발)
  npx prisma migrate dev --name <마이그레이션_이름>

  # 마이그레이션만 만들고 적용은 안 함
  npx prisma migrate dev --name <이름> --create-only

  # 예: 최초 마이그레이션
  npx prisma migrate dev --name init


## 2.1 db push (마이그레이션 파일 없이 스키마만 DB에 반영)

  npx prisma db push              
  # schema.prisma 내용을 DB에 바로 반영 (마이그레이션 기록 없음)
  # 프로토타입·빠른 동기화용. migrate dev 와 달리 마이그레이션 파일을 만들지 않음.
  # 호스트에서: pnpm run migrate 등과 마찬가지로 DATABASE_URL 이 필요 (예: .env.host 사용)


## 3. 마이그레이션 (배포용)

  # 배포 환경에서 마이그레이션만 적용 (마이그레이션 파일은 생성 안 함)
  npx prisma migrate deploy

  # 배포 시 DATABASE_URL 지정 예 (호스트에서)
  DATABASE_URL="postgresql://postgres:비밀번호@localhost:7432/postgres?schema=public" npx prisma migrate deploy


## 4. DB 리셋 (주의: 데이터 전부 삭제)

  npx prisma migrate reset       # DB 삭제 후 마이그레이션 처음부터 다시 적용
  # 시드 있으면 시드도 실행됨


## 5. Prisma Studio (DB GUI)

  npx prisma studio              # 브라우저에서 DB 데이터 확인·편집 (기본 http://localhost:5555)


## 6. 이 프로젝트에서의 실행 위치·환경

  - Prisma 명령은 **프로젝트 루트**에서 실행 (prisma/schema.prisma 있는 곳).
  - DB 주소:
    - **호스트(PC)**에서 실행 시: localhost:7432 (.env.host 사용)
    - **Docker 앱** 컨테이너에서 실행 시: kindergarten_db:5432 (.env 사용)


## 7. 이 프로젝트 npm/pnpm 스크립트 (호스트에서 DB 접속용)

  .env.host 를 쓰므로, Docker Postgres(호스트 포트 7432)에 접속합니다.

  pnpm run migrate               # 마이그레이션 개발 모드 (이름은 -- 로 전달)
  pnpm run migrate -- --name init

  pnpm run migrate:reset         # DB 리셋 후 마이그레이션 처음부터 적용 (데이터 삭제)

  pnpm run studio                # Prisma Studio 실행

  # npm 사용 시
  npm run migrate -- --name init
  npm run migrate:reset
  npm run studio


## 8. 흐름 요약

  1) 스키마 수정: prisma/schema.prisma 편집
  2) 마이그레이션 생성·적용: pnpm run migrate -- --name add_xxx
  3) (선택) Prisma Client 재생성: npx prisma generate (보통 migrate dev 가 자동 실행)
  4) 배포 시: DATABASE_URL 설정 후 npx prisma migrate deploy


## 9. 자주 나오는 상황

  - "Can't reach database server at kindergarten_db :5432"
    → 호스트(PC)에서 실행 중인데 .env 의 kindergarten_db 를 쓰고 있음.
    → pnpm run migrate / pnpm run studio 처럼 .env.host 를 쓰는 스크립트 사용, 또는
    → DATABASE_URL="postgresql://postgres:비밀번호@localhost:7432/postgres?schema=public" 로 한 번만 지정해서 실행.

  - "Drift detected" (마이그레이션 기록과 DB 스키마 불일치)
    → 데이터 버려도 되면: pnpm run migrate:reset
    → 데이터 보존 필요하면: 백업 후 리셋, 또는 baseline 등 별도 절차 필요 (DOCUMENT/DEPLOYMENT.md 참고).

  - 리셋 전 백업
    → 도커사용법.txt / DOCUMENT/DEPLOYMENT.md 의 DB 백업·복원 명령 참고.
